---

- name: create user {{tgt_user}}
  become: true
  user: 
    name: "{{tgt_user}}" 
    shell: /bin/bash 
    password: $6$5WhqbRWhmf$k5xvagkoif0j3y6jggZ.La.YZuE1.VCSP2f3KXzTCmNeD0VSZo/srlkYm0HxA8kP3HW75yltrom5sHdOL5jbz.
    update_password: on_create
    generate_ssh_key: yes 

- name: test for sudoers
  stat: path=/etc/sudoers.d/{{tgt_user}}
  become: true
  register: sudoer_file

- name: config sudoers for {{tgt_user}}
  become: true
  template:
    src: sudoer_line.j2
    dest: /etc/sudoers.d/{{tgt_user}}
    validate: 'visudo -cf %s'
  when: not sudoer_file.stat.exists

- name: copy public key
  copy:
    src: "~/.ssh/id_rsa.pub"
    dest: /tmp/host.pubkey
    force: true
  when: copyable_hostkey

- name: asdf1
  debug:
    msg: "HELLO ASDF"

- name: asdf2
  debug:
    var: copyable_hostkey

- name: test for pubkey
  stat: path=/tmp/host.pubkey
  register: host_pubkey

- name: qwer1
  debug:
    msg: "HELLO QWER"

- name: qwer2
  debug:
    var: host_pubkey

- name: set ssh key for {{tgt_user}} 
  authorized_key:
    user: "{{tgt_user}}"
    state: present
    key: "{{ lookup('file', '/tmp/host.pubkey') }}"
  when: host_pubkey.stat.exists

