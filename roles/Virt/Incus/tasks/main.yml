---

# incus
# https://linuxcontainers.org/incus/introduction/ 
# https://github.com/lxc/incus
# https://github.com/zabbly/incus 

- name: add incus apt key
  apt_key: 
    url: https://pkgs.zabbly.com/key.asc 
    state: present

- name: add incus repository
  apt_repository: 
    repo: 'deb https://pkgs.zabbly.com/incus/stable {{ ansible_distribution_release }} main'
    state: present
    update_cache: false

- name: install incus packages 
  apt: 
    pkg: "{{item}}"
    state: latest
    update_cache: false
  become: true
  with_items:
    - incus 
    - incus-client
    - incus-extra
    - incus-ui-canonical
    - zfsutils-linux

- name: create incus-admin group 
  group: 
    name: "{{item}}"
    state: present
  with_items: 
    - incus 
    - incus-admin

- name: add user to incus-admin 
  user: 
    name: "{{gen_user}}" 
    groups: "{{item}}"
    append: yes
  with_items: 
    - incus 
    - incus-admin

# distrobuilder 
# https://linuxcontainers.org/distrobuilder/downloads/ 
# https://linuxcontainers.org/distrobuilder/

- name: create pkg directory
  file: 
    path:  /home/{{gen_user}}/.pkg/distrobuilder
    state: directory 
    group: "{{gen_user}}" 
    owner: "{{gen_user}}"

- name: create bin directory
  file: 
    path:  /home/{{gen_user}}/.go/bin
    state: directory 
    group: "{{gen_user}}" 
    owner: "{{gen_user}}"

- name: clear old executable 
  file: 
    path:  /usr/{{gen_user}}/.go/bin/distrobuilder
    state: absent
 
- name: get executable
  get_url:
    url:  http://{{cblob_host}}/distrobuilder/distrobuilder-{{dbld_vsn}} 
    dest: /home/{{gen_user}}/.pkg/distrobuilder/distrobuilder-{{dbld_vsn}}
    force: yes
    mode: 'a+rx'
    group: "{{gen_user}}" 
    owner: "{{gen_user}}"
    validate_certs: no

- name: install symlinks
  file: 
    dest:  /home/{{gen_user}}/.pkg/distrobuilder/distrobuilder-{{dbld_vsn}}
    src:   /usr/{{gen_user}}/.go/bin/distrobuilder
    state: link
    force: yes
