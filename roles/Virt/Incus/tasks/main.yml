---

# incus
# https://linuxcontainers.org/incus/introduction/ 
# https://github.com/lxc/incus
# https://github.com/zabbly/incus 

- name: add incus apt key
  apt_key: 
    url: https://pkgs.zabbly.com/key.asc 
    state: present

- name: add incus repository
  apt_repository: 
    repo: 'deb https://pkgs.zabbly.com/incus/stable {{ ansible_distribution_release }} main'
    state: present
    update_cache: false

- name: install incus packages 
  apt: 
    pkg: "{{item}}"
    state: latest
    update_cache: false
  become: true
  with_items:
    - incus 
    - incus-client
    - incus-extra
    - incus-ui-canonical
    - zfsutils-linux

- name: create incus-admin group 
  group: 
    name: "{{item}}"
    state: present
  with_items: 
    - incus 
    - incus-admin

- name: add user to incus-admin 
  user: 
    name: "{{gen_user}}" 
    groups: "{{item}}"
    append: yes
  with_items: 
    - incus 
    - incus-admin

# distrobuilder 
# https://linuxcontainers.org/distrobuilder/downloads/ 
# https://linuxcontainers.org/distrobuilder/

- name: create pkg dir
  file: 
    path: /home/{{gen_user}}/.pkg/dbld/{{dbld_vsn}}
    state: directory 
    group: "{{gen_user}}"
    owner: "{{gen_user}}"

- name: get dbld tarfile 
  get_url:
    krl:  https://linuxcontainers.org/downloads/distrobuilder/distrobuilder-{{dbld_vsn}}.tar.gz
    dest: /home/{{gen_user}}/.pkg/dbld/{{dbld_vsn}}/dbld_{{dbld_vsn}}.tar.gz
    group: "{{gen_user}}"
    owner: "{{gen_user}}"

- name: expand dbld tarfile 
  unarchive:
    src:  /home/{{gen_user}}/.pkg/dbld/{{dbld_vsn}}/dbld_{{dbld_vsn}}.tar.gz
    dest: /home/{{gen_user}}/.pkg/dbld/{{dbld_vsn}}/
    remote_src: true
    group: "{{gen_user}}" 
    owner: "{{gen_user}}"

# - name: installation symlink
#   become: true
#   file: 
#     src:  /home/aleak/.pkg/dbld/{{dbld_vsn}}/x86_64-linux-gnu/bin/dbld
#     dest: /usr/local/bin/dbld
#     state: link
#
